
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ระบบบันทึกอุณหภูมิตู้เย็นยา (รายเดือน)</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
    <style>
        body { background: #f4f6f9; }
        .container-card {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 24px;
        }
        .valid-temp { color: green; font-weight: bold; }
        .invalid-temp { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="text-center mb-4">
            <h2 class="fw-bold">ระบบบันทึกอุณหภูมิตู้เย็นเก็บยา</h2>
            <p class="text-muted">หอผู้ป่วยหนักอายุรกรรม3 โรงพยาบาลศูนย์นครพิงค์</p>
        </div>

        <!-- ตารางกลาง -->
        <div class="container-card">
            <h4 class="mb-3">ข้อมูลบันทึกทั้งหมด</h4>
            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead class="table-primary">
                        <tr>
                            <th>วันที่</th>
                            <th>เวลา</th>
                            <th>กะ</th>
                            <th>อุณหภูมิ (°C)</th>
                            <th>พยาบาลผู้บันทึก</th>
                        </tr>
                    </thead>
                    <tbody id="centralTable">
                        <tr><td colspan="5" class="text-center text-muted">กำลังโหลด...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby2xwbtSIgYHFGLVJkQ0vyVG9T8XiW1OmD9DTdIK12ZIIa8bFVsktsRjnQIvoCryUmA/exec';

        // แปลง ISO datetime เป็น วันที่แบบไทย
        function formatDateThaiFromISO(isoString) {
            if (!isoString) return "";
            const date = new Date(isoString);
            const months = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.",
                "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear() + 543; // แปลงเป็น พ.ศ.
            return `${day} ${month} ${year}`;
        }

        // แปลง ISO datetime เป็น เวลาแบบไทย
        function formatTimeThaiFromISO(isoString) {
            if (!isoString) return "";
            const date = new Date(isoString);
            const hh = String(date.getHours()).padStart(2, "0");
            const mm = String(date.getMinutes()).padStart(2, "0");
            return `${hh}:${mm} น.`;
        }

        // โหลดข้อมูลตารางกลางจาก Google Sheet
        async function loadCentralTable() {
            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL);
                if (!response.ok) throw new Error("โหลดข้อมูลล้มเหลว");

                const data = await response.json();
                const centralTable = document.getElementById("centralTable");
                centralTable.innerHTML = "";

                if (!data || data.length === 0) {
                    centralTable.innerHTML = `<tr><td colspan="5" class="text-warning text-center">ไม่มีข้อมูล</td></tr>`;
                    return;
                }

                data.forEach(entry => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${formatDateThaiFromISO(entry.date)}</td>
                        <td>${formatTimeThaiFromISO(entry.date)}</td>
                        <td>${entry.shift}</td>
                        <td class="${entry.temperature >= 2 && entry.temperature <= 8 ? "valid-temp" : "invalid-temp"}">
                            ${entry.temperature}
                        </td>
                        <td>${entry.nurse}</td>
                    `;
                    centralTable.appendChild(row);
                });
            } catch (error) {
                console.error("Error loading central table:", error);
                document.getElementById("centralTable").innerHTML =
                    `<tr><td colspan="5" class="text-danger text-center">ไม่สามารถโหลดข้อมูล</td></tr>`;
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            loadCentralTable();
        });
    </script>
</body>
</html>

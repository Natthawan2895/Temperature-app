<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ระบบบันทึกอุณหภูมิตู้เย็นยา (รายเดือน)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
    <style>
        body { background: #f4f6f9; }
        .container-card {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            padding: 24px;
            margin-bottom: 24px;
        }
        .valid-temp { color: green; font-weight: bold; }
        .invalid-temp { color: red; font-weight: bold; }
        .custom-modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background-color: rgba(0,0,0,0.5);
            display:flex; justify-content:center; align-items:center; z-index:100;
        }
        .custom-modal-content {
            background:white; padding:32px; border-radius:12px;
            max-width:400px; text-align:center;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="text-center mb-4">
            <h2 class="fw-bold">ระบบบันทึกอุณหภูมิตู้เย็นเก็บยา</h2>
            <p class="text-muted">หอผู้ป่วยหนักอายุรกรรม3 โรงพยาบาลศูนย์นครพิงค์</p>
        </div>

        <div class="row g-3">
            <div class="col-12 col-md-6">
                <div class="container-card">
                    <h4 class="mb-3">เลือกวันที่</h4>
                    <input type="date" id="selectedDate" class="form-control" required />
                </div>
            </div>
            <div class="col-12 col-md-6">
                <div class="container-card">
                    <h4 class="mb-3">ฟอร์มบันทึกอุณหภูมิ</h4>
                    <form id="temperatureForm">
                        <div class="mb-3">
                            <label for="time" class="form-label">เลือกเวลา</label>
                            <input type="time" id="time" class="form-control" required />
                            <div id="shiftInfo" class="form-text fw-bold mt-1 text-primary"></div>
                        </div>
                        <div class="mb-3">
                            <label for="temperature" class="form-label">อุณหภูมิ (°C)</label>
                            <input type="number" step="0.1" id="temperature" class="form-control" required />
                            <div id="tempFeedback" class="form-text"></div>
                        </div>
                        <div class="mb-3">
                            <label for="nurse" class="form-label">ชื่อพยาบาลผู้บันทึก</label>
                            <input type="text" id="nurse" class="form-control" required />
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-save me-2"></i> บันทึก
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="container-card">
            <h4 class="mb-3">บันทึกอุณหภูมิประจำวัน</h4>
            <div class="d-flex justify-content-end mb-3">
                <button id="downloadCsvBtn" class="btn btn-success">
                    <i class="fas fa-download me-2"></i> ดาวน์โหลดรายงาน CSV ของเดือน
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead class="table-primary">
                        <tr>
                            <th>วันที่</th>
                            <th>เวลา</th>
                            <th>กะ</th>
                            <th>อุณหภูมิ (°C)</th>
                            <th>พยาบาลผู้บันทึก</th>
                        </tr>
                    </thead>
                    <tbody id="centralTable">
                        <tr><td colspan="5" class="text-muted">กำลังโหลดข้อมูล...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="container-card">
            <h4 class="mb-3">กราฟแนวโน้มอุณหภูมิ (°C)</h4>
            <div style="height: 400px;">
                <canvas id="tempChart"></canvas>
            </div>
        </div>
    </div>

    <div id="customModal" class="custom-modal d-none">
        <div class="custom-modal-content">
            <p id="modalMessage" class="fs-5 text-gray-700"></p>
            <button id="closeModalBtn" class="btn btn-primary w-100 mt-3">ตกลง</button>
        </div>
    </div>

    <script>
const form = document.getElementById("temperatureForm");
const recordTable = document.getElementById("centralTable");
const tempInput = document.getElementById("temperature");
const tempFeedback = document.getElementById("tempFeedback");
const datePicker = document.getElementById("selectedDate");
const timeInput = document.getElementById("time");
const shiftInfo = document.getElementById("shiftInfo");
const customModal = document.getElementById("customModal");
const modalMessage = document.getElementById("modalMessage");
const closeModalBtn = document.getElementById("closeModalBtn");

const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxcJmFBc-lMrpH1S24EHUZZszysV-2bV_1ArDbv_Sim5vI7F52fgjeR4b5_fF9PdoJP/exec';

// Chart.js
const ctx = document.getElementById("tempChart").getContext("2d");
const tempChart = new Chart(ctx, {
    type: "line",
    data: { labels: [], datasets: [{ label: "อุณหภูมิ", data: [], borderColor: "#007bff", fill: false }] },
    options: { responsive: true, maintainAspectRatio: false }
});

// ฟังก์ชันแปลงวันที่
// ฟังก์ชันแปลงวันที่ไทย
function formatDateThai(dateStr) {
    const date = new Date(dateStr);
    const months = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.",
        "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
    const d = date.getDate();
    const m = months[date.getMonth()];
    const y = date.getFullYear() + 543;
    return `${d} ${m} ${y}`;
}

function formatTimeThai(timeStr) {
    if (!timeStr) return "";

    const date = new Date(timeStr);

    // ดึงชั่วโมงและนาที (เวลา UTC)
    let hh = date.getUTCHours();
    let mm = date.getUTCMinutes();

    // แปลงเป็น string 2 หลัก
    hh = String(hh).padStart(2, "0");
    mm = String(mm).padStart(2, "0");

    return `${hh}:${mm} น.`;
}
function formatTimeThai2(isoTime) {
  if (!isoTime) return "";
  const date = new Date(isoTime);
  const hh = date.getUTCHours().toString().padStart(2, "0");
  const mm = date.getUTCMinutes().toString().padStart(2, "0");
  return `${hh}:${mm} น.`;
}

async function loadMonthlyData() {
    try {
        const response = await fetch(GOOGLE_APPS_SCRIPT_URL);
        if (!response.ok) throw new Error("โหลดข้อมูลล้มเหลว");

        const data = await response.json();
        const recordTable = document.getElementById("centralTable");
        const selectedDate = document.getElementById("selectedDate").value;

        if (!selectedDate) {
            recordTable.innerHTML = `<tr><td colspan="5" class="text-warning">กรุณาเลือกวันที่</td></tr>`;
            return;
        }

        // หาเดือนที่เลือก
        const selectedMonth = new Date(selectedDate).getMonth();
        const selectedYear = new Date(selectedDate).getFullYear();

        // กรองข้อมูลเฉพาะเดือนที่เลือก
        const monthlyData = data.filter(entry => {
            const d = new Date(entry.date);
            return d.getMonth() === selectedMonth && d.getFullYear() === selectedYear;
        });

        recordTable.innerHTML = "";
        tempChart.data.labels = [];
        tempChart.data.datasets[0].data = [];

        if (monthlyData.length === 0) {
            recordTable.innerHTML = `<tr><td colspan="5" class="text-warning">ไม่มีข้อมูลของเดือนนี้</td></tr>`;
            tempChart.update();
            return;
        }

        // เรียงข้อมูล
        monthlyData.sort((a, b) => new Date(a.date + "T" + a.time) - new Date(b.date + "T" + b.time));

        monthlyData.forEach(entry => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${formatDateThai(entry.date)}</td>
                <td>${formatTimeThai(entry.time)}</td>
                <td>${entry.shift}</td>
                <td class="${entry.temperature >= 2 && entry.temperature <= 8 ? "valid-temp" : "invalid-temp"}">
                    ${entry.temperature}
                </td>
                <td>${entry.nurse}</td>
            `;
            recordTable.appendChild(row);

            // เพิ่มข้อมูลลงกราฟ
            tempChart.data.labels.push(`${formatDateThai(entry.date)} ${formatTimeThai2(entry.time)}`);
            tempChart.data.datasets[0].data.push(entry.temperature);
        });

        tempChart.update();
    } catch (error) {
        console.error("Error loading monthly data:", error);
        document.getElementById("centralTable").innerHTML =
            `<tr><td colspan="5" class="text-danger">ไม่สามารถโหลดข้อมูล</td></tr>`;
    }
}

function showModal(message) {
    modalMessage.textContent = message;
    customModal.classList.remove('d-none');
}
closeModalBtn.addEventListener('click', () => customModal.classList.add('d-none'));

function getShiftFromTime(timeStr) {
    const [hh, mm] = timeStr.split(":").map(Number);
    const totalMins = hh * 60 + mm;
    if (totalMins <= 480) return "กะดึก (00.00-08.00)";
    if (totalMins <= 960) return "กะเช้า (08.01-16.00)";
    return "กะบ่าย (16.01-23.59)";
}

timeInput.addEventListener("input", () => {
    shiftInfo.textContent = timeInput.value ? `กะ: ${getShiftFromTime(timeInput.value)}` : "";
});

// โหลดข้อมูลจาก Google Sheet และอัปเดตทั้งตารางและกราฟ
async function loadCentralTable() {
    try {
        const response = await fetch(GOOGLE_APPS_SCRIPT_URL);
        if (!response.ok) throw new Error("โหลดข้อมูลล้มเหลว");

        const data = await response.json();
        recordTable.innerHTML = "";
        tempChart.data.labels = [];
        tempChart.data.datasets[0].data = [];

        if (!data || data.length === 0) {
            recordTable.innerHTML = `<tr><td colspan="5" class="text-warning">ไม่มีข้อมูล</td></tr>`;
            tempChart.update();
            return;
        }

        data.sort((a, b) => new Date(b.date + "T" + b.time) - new Date(a.date + "T" + a.time));

        data.forEach(entry => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${formatDateThai(entry.date)}</td>
                <td>${formatTimeThai(entry.time)}</td>
                <td>${entry.shift}</td>
                <td class="${entry.temperature >= 2 && entry.temperature <= 8 ? "valid-temp" : "invalid-temp"}">
                    ${entry.temperature}
                </td>
                <td>${entry.nurse}</td>
            `;
            recordTable.appendChild(row);

            // เพิ่มข้อมูลกราฟที่นี่
            tempChart.data.labels.push(`${formatDateThai(entry.date)} ${formatTimeThai2(entry.time)}`);
            tempChart.data.datasets[0].data.push(entry.temperature);
        });

        tempChart.update();

    } catch (error) {
        console.error("Error loading central table:", error);
        recordTable.innerHTML =
            `<tr><td colspan="5" class="text-danger">ไม่สามารถโหลดตารางกลาง</td></tr>`;
    }
}
form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const date = datePicker.value;
    const timeVal = timeInput.value;
    const shift = getShiftFromTime(timeVal);
    const temperature = parseFloat(tempInput.value);
    const nurse = document.getElementById("nurse").value.trim();

    if (!date || !timeVal || isNaN(temperature) || !nurse) {
        showModal("กรุณากรอกข้อมูลให้ครบถ้วน");
        return;
    }

    const formData = new FormData();
    formData.append('date', date);
    formData.append('time', timeVal);
    formData.append('shift', shift);
    formData.append('temperature', temperature.toFixed(1));
    formData.append('nurseName', nurse);

    try {
        const response = await fetch(GOOGLE_APPS_SCRIPT_URL, { method: 'POST', body: formData });
        const result = await response.json();
        if (result.result === "success") {
            showModal("บันทึกข้อมูลสำเร็จ!");
            form.reset();
            shiftInfo.textContent = "";
            tempFeedback.textContent = "";
            loadCentralTable();
        } else {
            showModal("บันทึกไม่สำเร็จ: " + result.error);
        }
    } catch (error) {
        showModal("ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้");
    }
});

document.addEventListener("DOMContentLoaded", () => {
    loadCentralTable();
});
</script>
</body>
</html>
